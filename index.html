<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Private Access Token Generator</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <style>
        /* Box sizing rules */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        /* Remove default margin */
        body,
        h1,
        h2,
        h3,
        h4,
        p,
        figure,
        blockquote,
        dl,
        dd {
            margin: 0;
            padding: 0;
            font-family: -apple-system, system-ui, sans-serif;
        }

        /* Remove list styles on ul, ol elements with a list role, which suggests default styling will be removed */
        ul[role="list"],
        ol[role="list"] {
            list-style: none;
        }

        /* Set core root defaults */
        html:focus-within {
            scroll-behavior: smooth;
        }

        /* Set core body defaults */
        body {
            min-height: 100vh;
            text-rendering: optimizeSpeed;
            line-height: 1.5;
        }

        /* A elements that don't have a class get default styles */
        a:not([class]) {
            text-decoration-skip-ink: auto;
        }

        /* Make images easier to work with */
        img,
        picture {
            max-width: 100%;
            display: block;
        }

        /* Inherit fonts for inputs and buttons */
        input,
        button,
        textarea,
        select {
            font: inherit;
        }

        html {
            max-width: 70ch;
            padding: 3em 1em;
            margin: auto;
            line-height: 1.75;
            font-size: 1.25em;
        }
        p,ul,ol {
            margin-bottom: 2em;
            color: #1d1d1d;
            font-family: sans-serif;
        }
        main {
            max-width: 38rem;
            width: 38rem;
            padding: 2rem;
        }
        select, code {
            display: block;
        }

        code {
            font-family: monospace;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr 4fr);
            grid-column-gap: 0.5rem;
        }
        .grid label {
            grid-column: span 2 / auto;
            margin-top: 0.5rem;
        }
        .grid select {
            margin-bottom: auto;
        }
        .grid input {
            margin-top: 0.25rem;
            margin-bottom: auto;
            line-height: 1rem;
            min-width: 10rem;
        }
        .grid input[type="button"] {
            min-width: auto;
        }
        .grid pre {
            overflow: scroll;
            grid-column: span 2 / auto;
        }

        .grid .grid {
            grid-template-columns: repeat(1, 4fr 1fr);
        }

    </style>
    <script>
        const CLOUDFLARE_DEMO_PUB_KEY = "MIIBUjA9BgkqhkiG9w0BAQowMKANMAsGCWCGSAFlAwQCAqEaMBgGCSqGSIb3DQEBCDALBglghkgBZQMEAgKiAwIBMAOCAQ8AMIIBCgKCAQEAmfx9AB3xGHk6MJhEo4QbUEv2ACjOFB8NV3kUuCSCldhSDKw5MNenDdSJGY8o9e4Zjlt249qJraUsstvhS7_6uKVfnf4-F80uUAnFvBkBQw3AmxoUN62VFZEF8JdQVRLobDD8R6Ck6Om4YSBDJ4Rc_F0_1p-aJXfVxb5MVTDGk7OKO00EDviNRP2an-nx67K8b7SgPyf6soZqgkLRg-IX7vJCMcnBNB7nxnCwAW1Og_AbnFjYUtbEgjcn3QJouFeFtQKMgXTqAJvjvGAaVZTgASucZrVmXRXg-zTKVkSmbl298zqooaz1eBAPy4M4SfQtfx-AiHJMjYYdA2NmzJz0qwIDAQAB";
        const CLOUDFLARE_PUB_KEY = "MIIBUjA9BgkqhkiG9w0BAQowMKANMAsGCWCGSAFlAwQCAqEaMBgGCSqGSIb3DQEBCDALBglghkgBZQMEAgKiAwIBMAOCAQ8AMIIBCgKCAQEA31_dzDPwYTZrxWRWlYcB8Qa2tiZ6VMUVDLNgLsLtl2jXDiF7i0JQjgWLS28X7o3-fgeKSh7290F1-6OksevONnjgwt2ejDqXZIQRqDpZX8ynZvRxsoU84fU48paBbEA8WrkIxtxT5vpf1xCodelaFfssNTg7I8ipFJNa_rCI3UGkkgTwkeytstZBCEhlkhAylZeNGI5KMP-j1-QboOEip5OkcI2zYycNF88l9pW8JBE3YRleUMwq42VX_EskAWOzu6MiZS38656zLoypug-44miauLTFVBQ1S-YTcuzm9AUEMJ_LlO6EbHAvtjvMzWzyDLaFWystwwadoVE7mqrwmwIDAQAB";
        const FASTLY_PUB_KEY = "MIICUjA9BgkqhkiG9w0BAQowMKANMAsGCWCGSAFlAwQCAqEaMBgGCSqGSIb3DQEBCDALBglghkgBZQMEAgKiAwIBMAOCAg8AMIICCgKCAgEAubzND7lvK";
        const publicKeys = new Map([
            ['demo-pat.issuer.cloudflare.com', CLOUDFLARE_DEMO_PUB_KEY],
            ['pat-issuer.cloudflare.com', CLOUDFLARE_PUB_KEY],
            ['demo-issuer.private-access-tokens.fastly.com', FASTLY_PUB_KEY],
        ]);

        function htonl(n) {
            return [(n >> 24) & 0xff, (n >> 16) & 0xff, (n >> 8) & 0xff, n & 0xff];
        }

        function htons(n) {
            return [(n >> 8) & 0xff, n & 0xff];
        }

        function stringToBinary(value) {
            return [...new TextEncoder().encode(value ?? '')]
        }

        function getElement(id) {
            return document.getElementById(id).value;
        }

        function bin2str(value = []) {
            return value.map(char => String.fromCharCode(char)).join('');
        }

        function base64url(data) {
            return btoa(data).replace(/\+/g, '-').replace(/\//g, '_')
        }

        function debugHex(name, value = []) {
            // hex encode
            // document.getElementById(name).innerHTML = "[" + value.map(v => v.toString(16).padStart(2, '0')).join(", ") + "]";

            // keep decimal encode - because humans
            document.getElementById(name).innerHTML = JSON.stringify(value).replaceAll(",", ", ");
        }

        function generateRedemption() {
            const value = Array(32).fill(0).map(() => Math.round(Math.random()*255).toString(16).padStart(2, '0')).join('');
            document.getElementById("redemption_context").value = value;
        }

        function hexToByte(s) {
            return s?.replaceAll(/[^0-9a-z]/gi, '0')?.match(/.{1,2}/g)?.map(a => parseInt(a, 16));
        }

        function getChallenge() {
            const tokenType = parseInt(getElement("token_type"));
            const issuerName = stringToBinary(getElement("issuer_name"));
            const redemptionContext = hexToByte(getElement("redemption_context"))?.concat(Array(32).fill(0))?.slice(0,32) || [];
            const originInfo = stringToBinary(getElement("origin_info"));

            debugHex('token_type_debug', htons(tokenType));
            debugHex('issuer_name_length_debug', htons(issuerName.length));
            debugHex('issuer_name_debug', issuerName);
            debugHex('redemption_context_length_debug', [redemptionContext.length]);
            debugHex('redemption_context_debug', redemptionContext);
            debugHex('origin_info_length_debug', htons(originInfo.length));
            debugHex('origin_info_debug', originInfo);

            const challenge = [].concat(
                htons(tokenType),
                htons(issuerName.length),
                issuerName,
                [redemptionContext.length],
                redemptionContext,
                htons(originInfo.length),
                originInfo)

            debugHex('challenge_debug', challenge);
            document.getElementById('challenge_base64_debug').innerHTML = base64url(bin2str(challenge)).match(/.{1,35}/g)?.join('<br>');

            return bin2str(challenge);
        }

        function update() {
            document.getElementById('output').innerHTML = `WWW-Authenticate: PrivateToken
    challenge=${base64url(getChallenge())},
    token-key=${publicKeys.get(getElement("issuer_name"))}`;
        }

        function init() {
            update();
            document.getElementsByTagName('body')[0].onkeyup = update;
            [...document.getElementsByTagName('select')].forEach(s => s.addEventListener('change', update));
            [...document.getElementsByTagName('input')].forEach(s => s.addEventListener('change', update));
            [...document.getElementsByTagName('input')].forEach(s => s.addEventListener('click', update));
        }

        window.addEventListener('load', init);
    </script>
</head>
<body>
<main>
    <h1>Private Access Token Generator <a href="https://github.com/colinbendell/private-access-token"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg></a></h1>
    <p>Safari 16 introduced support for Private Access Tokens. This tool helps generate valid <a href="https://www.ietf.org/archive/id/draft-ietf-privacypass-auth-scheme-05.html#section-2.1">PrivateToken</a> challenges for HTTP Authentication scheme.
        <br>
        ðŸ‘‰ <a href="/test.html">Test your browser</a>
    </p>
    <div class="grid">
        <label for="token_type"><a href="https://www.ietf.org/archive/id/draft-ietf-privacypass-protocol-06.html#section-8.1">Token Type</a></label>
        <select id="token_type">
            <option value="1">VOPRF (P-384, SHA-384)</option>
            <option value="2" selected>Blind RSA (SHA-384, 2048-bit)</option>
        </select>
        <div>
            <code id="token_type_debug"></code>
        </div>
        <label for="issuer_name">Issuer (hostname)</label>
        <select id="issuer_name">
            <option value="demo-pat.issuer.cloudflare.com" selected>â€¦demo.cloudflare.com</option>
            <option value="pat-issuer.cloudflare.com">pat-issuer.cloudflare.com</option>
            <option value="demo-issuer.private-access-tokens.fastly.com">â€¦issuer.fastly.com</option>
        </select>
        <div>
            <code id="issuer_name_length_debug"></code>
            <code id="issuer_name_debug"></code>
        </div>
        <label for="redemption_context">Redemption Context</label>
        <div class="grid">
            <input type="text" id="redemption_context" value="">
            <input type="button" value="Generate" onclick="generateRedemption()">
        </div>
        <div>
            <code id="redemption_context_length_debug"></code>
            <code id="redemption_context_debug"></code>
        </div>
            <label for="origin_info">Origin (hostname)</label>
            <input type="text" id="origin_info" placeholder="shoesbycolin.com">
        <div>
            <code id="origin_info_length_debug"></code>
            <code id="origin_info_debug"></code>
        </div>

<!--        <label for="challenge_debug">&nbsp;</label>-->
        <div style="margin-top:1.5rem">TokenChallenge</div>
        <div style="margin-top:1.5rem">
            <code id="challenge_debug"></code>
            <code id="challenge_base64_debug" style="margin-top:1rem"></code>
        </div>

        <pre id="output"></pre>
    </div>
</main>
</body>
</html>
